<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PG113 - Users Module</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="/js/app.js"></script>
    <style>.hidden{display:none}</style>
</head>
<body>
<!-- NAVBAR -->
<nav id="navbar" class="navbar navbar-expand-lg navbar-dark bg-dark hidden">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">PG113</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav me-auto">
                <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('dashboard')">Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('profile')">My Profile</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('users')">Users</a></li>
            </ul>
            <span id="navUser" class="text-white me-3"></span>
            <button id="logoutBtn" class="btn btn-outline-danger btn-sm">Logout</button>
        </div>
    </div>
</nav>

<!-- LOGIN / REGISTER SCREEN -->
<div id="loginSection" class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-4">

            <div id="authTabs" class="mb-3 text-center">
                <button class="btn btn-link" onclick="showAuth('login')">Login</button> |
                <button class="btn btn-link" onclick="showAuth('register')">Register</button>
            </div>

            <!-- LOGIN FORM -->
            <div id="loginBox">
                <h2 class="mb-3">Login</h2>
                <form id="loginForm" class="card card-body">
                    <input id="loginUser" class="form-control mb-2" placeholder="Username" required>
                    <input id="loginPass" type="password" class="form-control mb-2" placeholder="Password" required>
                    <button class="btn btn-primary">Login</button>
                </form>
                <div id="loginMsg" class="mt-2"></div>
            </div>

            <!-- REGISTER FORM -->
            <div id="registerBox" class="hidden">
                <h2 class="mb-3">Register</h2>
                <form id="registerForm" class="card card-body">
                    <input id="regUser" class="form-control mb-2" placeholder="Username" required>
                    <input id="regEmail" type="email" class="form-control mb-2" placeholder="Email" required>
                    <input id="regPass" type="password" class="form-control mb-2" placeholder="Password (min 6)" required>
                    <button class="btn btn-success">Register</button>
                </form>
                <div id="registerMsg" class="mt-2"></div>
            </div>

        </div>
    </div>
</div>

<!-- APP SECTIONS -->
<div id="app" class="container py-4 hidden">
    <!-- Dashboard -->
    <div id="dashboard" class="section">
        <h2>Dashboard</h2>
        <p>Welcome to PG113 Event Planning System.</p>
    </div>

    <!-- Profile -->
    <div id="profile" class="section hidden">
        <h2>My Profile</h2>
        <div id="profileContent" class="card card-body mt-3"></div>
    </div>

    <!-- Users -->
    <div id="users" class="section hidden">
        <div class="d-flex justify-content-between mb-3">
            <h2>Users</h2>
            <button class="btn btn-success btn-sm" onclick="showUserForm()">+ New User</button>
        </div>
        <div id="userMsg"></div>
        <table class="table table-bordered">
            <thead><tr><th>ID</th><th>Username</th><th>Email</th><th>Role</th><th></th></tr></thead>
            <tbody id="userRows"></tbody>
        </table>
        <div id="userForm" class="card p-3 hidden"></div>
    </div>
</div>

<script>
    // Toggle login/register forms
    function showAuth(which) {
        document.getElementById("loginBox").classList.add("hidden");
        document.getElementById("registerBox").classList.add("hidden");
        if (which === "login") document.getElementById("loginBox").classList.remove("hidden");
        if (which === "register") document.getElementById("registerBox").classList.remove("hidden");
    }

    // Login flow
    document.getElementById("loginForm").addEventListener("submit", async e=>{
        e.preventDefault();
        try{
            const res = await fetch(API_BASE+"/api/auth/login",{
                method:"POST",
                headers:{ "Content-Type":"application/json"},
                body: JSON.stringify({ username:loginUser.value, password:loginPass.value })
            });
            if(!res.ok) throw new Error("Invalid login");
            const data=await res.json();
            saveToken(data.token);
            startApp();
        }catch(err){
            loginMsg.innerHTML=`<div class="alert alert-danger">${err.message}</div>`;
        }
    });

    // Register flow (default role = USER)
    document.getElementById("registerForm").addEventListener("submit", async e=>{
        e.preventDefault();
        try {
            const body = {
                username: regUser.value.trim(),
                email: regEmail.value.trim(),
                password: regPass.value,
                role: "USER"
            };
            const res = await fetch(API_BASE+"/api/users", {
                method:"POST",
                headers:{ "Content-Type":"application/json"},
                body: JSON.stringify(body)
            });
            if (!res.ok) throw new Error("Registration failed");
            registerMsg.innerHTML = `<div class="alert alert-success">Account created! Please login.</div>`;
            showAuth("login");
        } catch(err) {
            registerMsg.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
        }
    });

    async function startApp(){
        document.getElementById("loginSection").classList.add("hidden");
        document.getElementById("navbar").classList.remove("hidden");
        document.getElementById("app").classList.remove("hidden");
        try{
            const me=await apiRequest("/api/users/me");
            document.getElementById("navUser").innerText=`${me.username} (${me.role})`;
            showSection("dashboard");
        }catch(err){
            clearToken(); location.reload();
        }
    }

    // Section switching
    function showSection(id){
        document.querySelectorAll('.section').forEach(s=>s.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        if(id==='profile') loadProfile();
        if(id==='users') loadUsers();
    }

    // Profile
    async function loadProfile(){
        const me=await apiRequest("/api/users/me");
        profileContent.innerHTML=`
      <ul class="list-group">
        <li class="list-group-item"><b>ID:</b> ${me.id}</li>
        <li class="list-group-item"><b>Username:</b> ${me.username}</li>
        <li class="list-group-item"><b>Email:</b> ${me.email}</li>
        <li class="list-group-item"><b>Role:</b> ${me.role}</li>
      </ul>`;
    }

    // Users
    async function loadUsers(){
        const data=await apiRequest("/api/users?page=0&size=20");
        userRows.innerHTML="";
        data.content.forEach(u=>{
            userRows.innerHTML+=`
        <tr>
          <td>${u.id}</td><td>${u.username}</td><td>${u.email}</td><td>${u.role}</td>
          <td>
            <button class="btn btn-warning btn-sm" onclick="editUser(${u.id})">Edit</button>
            <button class="btn btn-danger btn-sm" onclick="deleteUser(${u.id})">Del</button>
          </td>
        </tr>`;
        });
    }

    function showUserForm(u=null){
        userForm.classList.remove("hidden");
        userForm.innerHTML=`
      <h5>${u?"Edit":"Create"} User</h5>
      <form id="f">
        <input type="hidden" id="uid" value="${u?u.id:""}">
        <input class="form-control mb-2" id="uname" placeholder="Username" value="${u?u.username:""}" ${u?"disabled":""}>
        <input class="form-control mb-2" id="uemail" placeholder="Email" value="${u?u.email:""}">
        ${u?"":'<input class="form-control mb-2" id="upass" type="password" placeholder="Password">'}
        <select class="form-select mb-2" id="urole">
          <option ${u&&u.role==="USER"?"selected":""}>USER</option>
          <option ${u&&u.role==="ORGANIZER"?"selected":""}>ORGANIZER</option>
          <option ${u&&u.role==="VENDOR"?"selected":""}>VENDOR</option>
          <option ${u&&u.role==="ADMIN"?"selected":""}>ADMIN</option>
        </select>
        <button class="btn btn-primary btn-sm">Save</button>
        <button type="button" class="btn btn-secondary btn-sm" onclick="userForm.classList.add('hidden')">Cancel</button>
      </form>`;
        document.getElementById("f").addEventListener("submit",saveUser);
    }

    async function saveUser(e){
        e.preventDefault();
        const id=uid.value;
        const body={ email:uemail.value, role:urole.value };
        if(!id){ body.username=uname.value; body.password=upass.value; }
        const method=id?"PUT":"POST";
        const path=id?`/api/users/${id}`:"/api/users";
        await apiRequest(path,{method, body:JSON.stringify(body)});
        userForm.classList.add("hidden"); loadUsers();
    }

    async function editUser(id){ const u=await apiRequest(`/api/users/${id}`); showUserForm(u); }
    async function deleteUser(id){ if(confirm("Delete user?")){ await apiRequest(`/api/users/${id}`,{method:"DELETE"}); loadUsers(); } }

    // Logout
    document.getElementById("logoutBtn").addEventListener("click",()=>{ clearToken(); location.reload(); });

    // Auto start if already logged in
    if(getToken()) startApp();
</script>
</body>
</html>
