<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Edit User - PG113</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="/js/app.js"></script>
</head>
<body class="container py-5">
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4">Edit User</h1>
    <div class="d-flex gap-2">
        <a href="/users/list.html" class="btn btn-outline-secondary">Back</a>
        <button id="logoutBtn" class="btn btn-danger">Logout</button>
    </div>
</div>

<div id="msg"></div>

<form id="form" class="col-md-5">
    <div class="mb-2"><b>Username:</b> <span id="username"></span></div>
    <div class="mb-3">
        <label class="form-label">Email</label>
        <input id="email" type="email" class="form-control" required maxlength="100">
    </div>
    <div class="mb-3">
        <label class="form-label">Role</label>
        <select id="role" class="form-select">
            <option>USER</option>
            <option>ORGANIZER</option>
            <option>VENDOR</option>
            <option>ADMIN</option>
        </select>
    </div>
    <button class="btn btn-primary">Save</button>
</form>

<script>
    function toast(type, text) {
        document.getElementById("msg").innerHTML =
            `<div class="alert alert-${type}">${text}</div>`;
        setTimeout(()=> document.getElementById("msg").innerHTML = "", 2500);
    }

    document.getElementById("logoutBtn").addEventListener("click", () => {
        clearToken(); window.location.href = "/login.html";
    });

    // get id from query ?id=123
    const params = new URLSearchParams(location.search);
    const id = params.get("id");

    async function load() {
        try {
            const u = await apiRequest(`/api/users/${id}`);
            document.getElementById("username").textContent = u.username;
            document.getElementById("email").value = u.email;
            document.getElementById("role").value = u.role;
        } catch (err) {
            toast("danger", "Load failed or unauthorized");
            setTimeout(()=> window.location.href = "/login.html", 1200);
        }
    }

    document.getElementById("form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const body = {
            email: document.getElementById("email").value.trim(),
            role: document.getElementById("role").value
        };
        try {
            await apiRequest(`/api/users/${id}`, { method: "PUT", body: JSON.stringify(body) });
            toast("success", "Updated");
            setTimeout(()=> window.location.href = "/users/list.html", 600);
        } catch (err) {
            toast("danger", "Update failed (need ADMIN or validation error)");
        }
    });

    load();
</script>
</body>
</html>
