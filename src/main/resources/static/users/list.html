<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Users - PG113</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="/js/app.js"></script>
</head>
<body class="container py-5">
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3">Users</h1>
    <div class="d-flex gap-2">
        <a href="/me.html" class="btn btn-outline-secondary">My Profile</a>
        <a href="/users/new.html" class="btn btn-success">+ New User</a>
        <button id="logoutBtn" class="btn btn-danger">Logout</button>
    </div>
</div>

<div id="msg"></div>

<form id="searchForm" class="row g-2 mb-3">
    <div class="col-auto">
        <input id="q" class="form-control" placeholder="Search username or email">
    </div>
    <div class="col-auto">
        <button class="btn btn-primary" type="submit">Search</button>
    </div>
</form>

<div class="table-responsive">
    <table class="table table-striped align-middle">
        <thead class="table-light">
        <tr>
            <th>ID</th>
            <th>Username</th>
            <th>Email</th>
            <th>Role</th>
            <th class="text-end">Actions</th>
        </tr>
        </thead>
        <tbody id="rows"></tbody>
    </table>
</div>

<div class="d-flex justify-content-end align-items-center gap-2">
    <button id="prevBtn" class="btn btn-outline-secondary btn-sm">Prev</button>
    <span id="pageInfo" class="small"></span>
    <button id="nextBtn" class="btn btn-outline-secondary btn-sm">Next</button>
</div>

<script>
    let page = 0;
    const size = 10;

    function toast(type, text) {
        document.getElementById("msg").innerHTML =
            `<div class="alert alert-${type}">${text}</div>`;
        setTimeout(()=> document.getElementById("msg").innerHTML = "", 2500);
    }

    async function load() {
        try {
            const q = document.getElementById("q").value || "";
            const data = await apiRequest(`/api/users?q=${encodeURIComponent(q)}&page=${page}&size=${size}`);
            const tbody = document.getElementById("rows");
            tbody.innerHTML = "";
            data.content.forEach(u => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
            <td>${u.id}</td>
            <td>${u.username}</td>
            <td>${u.email}</td>
            <td>${u.role}</td>
            <td class="text-end">
              <a href="/users/edit.html?id=${u.id}" class="btn btn-sm btn-warning me-1">Edit</a>
              <button class="btn btn-sm btn-danger" data-id="${u.id}">Delete</button>
            </td>
          `;
                tbody.appendChild(tr);
            });

            // paging info
            document.getElementById("pageInfo").innerText = `Page ${data.number + 1} / ${data.totalPages || 1}`;
            document.getElementById("prevBtn").disabled = data.number <= 0;
            document.getElementById("nextBtn").disabled = data.number >= (data.totalPages - 1);

            // attach delete handlers
            document.querySelectorAll('button[data-id]').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    if (!confirm('Delete this user?')) return;
                    try {
                        await apiRequest(`/api/users/${btn.dataset.id}`, { method: 'DELETE' });
                        toast('success', 'Deleted');
                        load();
                    } catch (err) {
                        toast('danger', 'Delete failed (need ADMIN or token expired)');
                    }
                });
            });

        } catch (err) {
            toast('danger', 'Unauthorized. Please login as ADMIN.');
            setTimeout(()=> window.location.href = '/login.html', 1200);
        }
    }

    document.getElementById("searchForm").addEventListener("submit", (e) => {
        e.preventDefault();
        page = 0;
        load();
    });
    document.getElementById("prevBtn").addEventListener("click", (e) => {
        e.preventDefault();
        if (page > 0) { page--; load(); }
    });
    document.getElementById("nextBtn").addEventListener("click", (e) => {
        e.preventDefault();
        page++; load();
    });
    document.getElementById("logoutBtn").addEventListener("click", () => {
        clearToken();
        window.location.href = "/login.html";
    });

    load();
</script>
</body>
</html>
